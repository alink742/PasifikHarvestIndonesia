<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PASIFIK HARVEST INDONESIA - IoT Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@500;700;800&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-dash: #0f172a;
            --card-dash: #1e293b;
            --border: #334155;
            --text-highlight: #ffffff; 
            --text-label: #94a3b8;
            --primary: #38bdf8;
            --success: #4ade80;
            --danger: #f87171;
            --warning: #facc15;
            --purple: #c084fc;
            --wa-header: #1e293b; 
            --wa-tab: #0f172a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: var(--bg-dash); color: var(--text-highlight);
            overflow-x: hidden; padding-bottom: 50px;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        /* --- LOGIN --- */
        #loginPage {
            height: 100vh; display: flex; justify-content: center; align-items: center;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999;
            background: linear-gradient(135deg, #020617 0%, #1e1b4b 100%); padding: 20px;
        }
        .login-card {
            background: #ffffff; padding: 30px; width: 100%; max-width: 400px;
            border-radius: 8px; text-align: center; color: #0f172a;
        }
        .login-logo { max-width: 120px; height: auto; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; 
            border-radius: 4px; background: #f8fafc; color: #334155; font-size: 1rem; outline: none;
        }
        .login-btn {
            width: 100%; padding: 12px; background: #0f172a; color: white; border: none; border-radius: 4px;
            font-weight: 700; cursor: pointer; transition: 0.2s;
        }

        /* =========================================
           DESKTOP HEADER
           ========================================= */
        header {
            background: var(--card-dash); 
            padding: 15px 25px; 
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .brand-section { display: flex; align-items: center; gap: 15px; cursor: default; }
        .header-logo { height: 42px; width: auto; background: white; padding: 2px; border-radius: 50%; }
        .brand-text h2 { margin: 0; font-size: 1.1rem; color: var(--text-highlight); font-weight: 700; letter-spacing: 1px; }
        .brand-text span { font-size: 0.7rem; color: var(--text-label); display: block; }
        
        .nav-menu { display: flex; gap: 10px; align-items: center; }
        #clock { font-family: 'JetBrains Mono', monospace; font-size: 1.3rem; font-weight: 700; color: var(--warning); margin-right: 15px; }
        
        nav button, nav select {
            padding: 10px 16px; border-radius: 6px; border: 1px solid var(--border);
            background: #0f172a; color: var(--text-highlight); font-size: 0.85rem; font-weight: 600;
            cursor: pointer; white-space: nowrap; font-family: 'Inter', sans-serif;
        }
        nav button:hover { background: #334155; }
        .btn-save { background: #15803d !important; border-color: #15803d !important; }
        .btn-reset { background: #b91c1c !important; border-color: #b91c1c !important; }

        .mobile-header-right, .bottom-nav, .mobile-menu-dropdown { display: none; }

        /* --- DASHBOARD CONTENT --- */
        .container { padding: 30px; max-width: 1600px; margin: 0 auto; }
        #section-totals, #section-lines, #section-chart { display: block; } 

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 35px; }
        .card { background: var(--card-dash); padding: 20px; border-radius: 6px; border: 1px solid var(--border); transition: 0.2s; display: flex; flex-direction: column; justify-content: center; }
        .card:hover { border-color: var(--text-label); background: #263346; }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .card-title { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--text-highlight); font-size: 1.1rem; }
        .card-speed { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 0.9rem; color: var(--text-label); }
        
        .badge { font-size: 0.65rem; padding: 4px 8px; border-radius: 4px; font-weight: 800; display: inline-block; margin-top: 5px; letter-spacing: 0.5px; }
        .badge-club { background: rgba(56, 189, 248, 0.15); color: var(--primary); border: 1px solid rgba(56, 189, 248, 0.3); }
        .badge-pouch { background: rgba(192, 132, 252, 0.15); color: var(--purple); border: 1px solid rgba(192, 132, 252, 0.3); }

        .mini-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .mini-table th { text-align: left; color: var(--text-label); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; padding-bottom: 8px; }
        .mini-table td { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; font-weight: 700; padding-top: 5px; color: #ffffff; }
        
        .grand-card { background: linear-gradient(135deg, #1e293b, #0f172a); padding: 25px; border-radius: 6px; border: 2px solid var(--warning); text-align: center; }
        .grand-label { font-size: 0.8rem; color: var(--warning); letter-spacing: 2px; font-weight: 800; text-transform: uppercase; margin-bottom: 10px; }
        .grand-val { font-family: 'JetBrains Mono', monospace; font-size: 3.8rem; font-weight: 800; color: white; line-height: 1; }
        
        .reset-control { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 20px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #334155; display: inline-flex; }
        .time-group { display: flex; align-items: center; gap: 5px; }
        .time-btn { background: #334155; color: white; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .time-display { background: #000; color: var(--primary); font-family: 'JetBrains Mono', monospace; padding: 5px; border-radius: 4px; border: 1px solid #475569; font-size: 1.1rem; width: 50px; text-align: center; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }

        .chart-container { background: var(--card-dash); padding: 25px; border-radius: 6px; border: 1px solid var(--border); margin-top: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-filters button { background: transparent; border: 1px solid var(--border); color: var(--text-label); padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 5px; cursor: pointer; }
        .chart-filters button.active { background: var(--primary); color: #0f172a; border-color: var(--primary); }
        .canvas-wrapper { position: relative; height: 350px; width: 100%; }
        
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { white-space: nowrap; }

        /* =========================================
           MOBILE STYLE FIX
           ========================================= */
        @media (max-width: 768px) {
            header {
                position: fixed; top: 0; left: 0; width: 100%;
                background: var(--wa-header); border-bottom: 1px solid #334155;
                padding: 10px 15px; justify-content: space-between; height: 60px; z-index: 1000;
            }
            .nav-menu { display: none; } 
            
            .brand-section { width: auto; justify-content: flex-start; }
            .header-logo { height: 35px; margin-right: 10px; }
            .brand-text h2 { font-size: 1rem; }
            .brand-text span { display: block; font-size: 0.65rem; text-align: left; }

            .mobile-header-right { display: flex; align-items: center; gap: 10px; }
            .mobile-clock { color: var(--warning); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700; }
            .mobile-kebab-menu { display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; color: white; font-size: 1.5rem; cursor: pointer; }
            
            .mobile-menu-dropdown {
                display: none; position: fixed; top: 55px; right: 10px;
                background: #1e293b; border: 1px solid #334155;
                border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                flex-direction: column; width: 180px; z-index: 1001;
            }
            .mobile-menu-dropdown.active { display: flex; }
            .mobile-menu-dropdown button, .mobile-menu-dropdown select {
                background: transparent; border: none; border-bottom: 1px solid #334155;
                color: white; padding: 12px 15px; text-align: left; font-size: 0.85rem; 
                width: 100%; border-radius: 0; text-transform: uppercase; font-weight: 600;
            }
            .mobile-menu-dropdown select { background: #0f172a; margin: 0; text-transform: none; }
            
            .bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
                height: 65px; background: var(--wa-tab); border-top: 1px solid #334155;
                z-index: 1000; justify-content: space-around; align-items: center;
            }
            .nav-item {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                color: #94a3b8; font-size: 0.7rem; font-weight: 600; gap: 4px; width: 33%; height: 100%;
                cursor: pointer; transition: 0.2s;
            }
            .nav-item.active { color: var(--primary); border-top: 3px solid var(--primary); background: rgba(56, 189, 248, 0.05); }
            .nav-icon { width: 24px; height: 24px; fill: currentColor; }

            body { padding-top: 70px; padding-bottom: 80px; }
            .container { padding: 10px; }
            
            #section-totals, #section-lines, #section-chart { display: none; animation: fadeIn 0.3s; }
            #section-lines { display: block; } 

            .summary-grid { grid-template-columns: 1fr; gap: 10px; margin-bottom: 0; }
            .grid { grid-template-columns: 1fr; gap: 10px; }
            
            /* --- KARTU TOTAL UI MOBILE FIX --- */
            .card, .grand-card { 
                padding: 15px; min-height: 120px; margin-bottom: 0;
                background: var(--card-dash); border: 1px solid var(--border);
            }
            .summary-grid .mini-table colgroup col:nth-child(1) { width: 50% !important; }
            .summary-grid .mini-table colgroup col:nth-child(2) { width: 25% !important; }
            .summary-grid .mini-table colgroup col:nth-child(3) { width: 25% !important; }
            .summary-grid .mini-table { table-layout: auto; }
            
            .mini-table td { font-size: 1.4rem; padding-top: 2px; }
            .mini-table th { font-size: 0.7rem; }
            
            .grand-val { font-size: 1.4rem; margin: 0; margin-top: 5px; color: white; }
            .grand-label { font-size: 1.1rem; color: var(--text-highlight); font-family: 'JetBrains Mono', monospace; font-weight:700; margin-bottom:0; text-transform: none; letter-spacing: 0; }
            
            .reset-control { width: 100%; justify-content: center; padding: 5px; margin-top: 10px; font-size: 0.7rem; }

            .table-responsive table { width: 100%; table-layout: fixed; white-space: normal; }
            .table-responsive th { font-size: 0.75rem; vertical-align: middle; }
            .table-responsive td { font-size: 0.85rem; padding: 8px 5px; vertical-align: middle; word-wrap: break-word; }
            .table-responsive th:nth-child(1), .table-responsive td:nth-child(1) { width: 30%; }
            .table-responsive th:nth-child(2), .table-responsive td:nth-child(2) { width: 25%; text-align: center; }
            .table-responsive th:nth-child(3), .table-responsive td:nth-child(3) { width: 45%; }

            .chart-filters { display: flex; justify-content: space-between; gap: 5px; }
            .chart-filters button { flex: 1; margin: 0; padding: 6px 0; font-size: 0.7rem; text-align: center; }
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body>

    <div id="loginPage">
        <div class="login-card">
            <img src="phi.png" alt="Pasific Harvest" class="login-logo" onerror="this.style.display='none'">
            <h1 class="login-title">SYSTEM LOGIN</h1>
            <p style="color:#64748b; margin-bottom:20px;">Production Monitoring</p>
            <input id="username" class="login-input" type="text" placeholder="Username" autocomplete="off" autofocus>
            <input id="password" class="login-input" type="password" placeholder="Password">
            <button id="btnLogin" class="login-btn" onclick="doLogin()">ACCESS DASHBOARD</button>
            <p id="error" style="color:#ef4444; margin-top:15px; font-weight:600;"></p>
        </div>
    </div>

    <div id="dashboardPage" style="display:none;">
        
        <header id="mainHeader">
            <div class="brand-section">
                <img src="phi.png" alt="Logo" class="header-logo" onerror="this.style.display='none'">
                <div class="brand-text">
                    <h2>PASIFIK HARVEST INDONESIA</h2>
                    <span>INTEGRATED IOT SYSTEM</span>
                </div>
            </div>

            <div class="nav-menu">
                <div id="clock">--:--:--</div>
                <nav>
                    <button onclick="switchView('dashboard')" style="border-color:var(--text-highlight);">Dashboard</button>
                    <button onclick="switchView('history')">History</button>
                    <select id="machineSelectDesktop" onchange="syncSelect(this.value)">
                        <option value="" disabled selected>-- SELECT MACHINE --</option>
                        <option value="all">⚠ RESET ALL</option>
                        <option value="machine01">MACHINE 01</option>
                        <option value="machine02">MACHINE 02</option>
                        <option value="machine03">MACHINE 03</option>
                        <option value="machine04">MACHINE 04</option>
                        <option value="machine05">MACHINE 05</option>
                        <option value="machine06">MACHINE 06</option>
                        <option value="machine07">MACHINE 07</option>
                    </select>
                    <button class="btn-save" onclick="manualSave()">SAVE DATA</button>
                    <button class="btn-reset" onclick="resetCounter()">RESET</button>
                    <button onclick="logout()" style="border-color:#ef4444; color:#ef4444;">LOGOUT</button>
                </nav>
            </div>

            <div class="mobile-header-right">
                <div id="mobileClock" class="mobile-clock">--:--:--</div>
                <div class="mobile-kebab-menu" onclick="toggleMobileDropdown()">
                    <span>&#8942;</span>
                </div>
            </div>
        </header>

        <div class="mobile-menu-dropdown" id="mobileDropdown">
            <button onclick="switchView('dashboard'); toggleMobileDropdown();">Dashboard View</button>
            <button onclick="switchView('history'); toggleMobileDropdown();">History Logs</button>
            <select id="machineSelectMobile" onchange="syncSelect(this.value)">
                <option value="" disabled selected>-- PILIH MESIN --</option>
                <option value="all">⚠ RESET ALL MACHINES</option>
                <option value="machine01">MACHINE 01</option>
                <option value="machine02">MACHINE 02</option>
                <option value="machine03">MACHINE 03</option>
                <option value="machine04">MACHINE 04</option>
                <option value="machine05">MACHINE 05</option>
                <option value="machine06">MACHINE 06</option>
                <option value="machine07">MACHINE 07</option>
            </select>
            <button class="btn-save" onclick="manualSave(); toggleMobileDropdown();" style="color:#4ade80;">SAVE DATA</button>
            <button class="btn-reset" onclick="resetCounter(); toggleMobileDropdown();" style="color:#f87171;">RESET COUNTER</button>
            <button onclick="logout()" style="color:#ef4444; font-weight:bold;">LOGOUT</button>
        </div>

        <div class="container" id="viewDashboard">
            
            <div id="section-totals">
                <div class="summary-grid">
                    <div class="card" style="border-top: 4px solid var(--primary);">
                        <div class="card-header">
                            <div><span class="card-title" style="color:var(--primary)">TOTAL CLUBCAN</span><span class="badge badge-club">LINES 01-04, 07-12, 14-15</span></div>
                        </div>
                        <table class="mini-table">
                            <colgroup><col style="width:40%"><col style="width:30%"><col style="width:30%"></colgroup>
                            <tr><th>Actual</th><th style="text-align:center">THEORITICAL</th><th style="text-align:right">Eff %</th></tr>
                            <tr><td class="data-val" id="clubActual">0</td><td class="data-val" style="text-align:center" id="clubPredict">0</td><td class="data-val" style="text-align:right" id="clubEff">0%</td></tr>
                        </table>
                    </div>

                    <div class="card" style="border-top: 4px solid var(--purple);">
                        <div class="card-header">
                            <div><span class="card-title" style="color:var(--purple)">TOTAL ROUNDCAN</span><span class="badge badge-pouch">LINE 05 & 06</span></div>
                        </div>
                        <table class="mini-table">
                            <colgroup><col style="width:40%"><col style="width:30%"><col style="width:30%"></colgroup>
                            <tr><th>Actual</th><th style="text-align:center">THEORITICAL</th><th style="text-align:right">Eff %</th></tr>
                            <tr><td class="data-val" id="pouchActual">0</td><td class="data-val" style="text-align:center" id="pouchPredict">0</td><td class="data-val" style="text-align:right" id="pouchEff">0%</td></tr>
                        </table>
                    </div>

                    <div class="grand-card">
                        <div class="card-header">
                            <div><span class="grand-label">GRAND TOTAL</span><span class="badge" style="background:rgba(250,204,21,0.2); color:#facc15; border:1px solid rgba(250,204,21,0.4);">PRODUCTION</span></div>
                        </div>
                        <table class="mini-table">
                             <tr><td colspan="3" class="grand-val" id="grandTotal" style="text-align:left;">0</td></tr>
                        </table>
                        <div class="reset-control">
                            <span style="font-weight:bold; color:#94a3b8; text-transform:uppercase;">Auto Reset:</span>
                            <div class="time-group">
                                <button class="time-btn" onclick="adjustTime('setHour', -1, 23)">-</button>
                                <input id="setHour" class="time-display" value="16" readonly>
                                <button class="time-btn" onclick="adjustTime('setHour', 1, 23)">+</button>
                            </div>
                            <span style="font-weight:bold; color:#94a3b8;">:</span>
                            <div class="time-group">
                                <button class="time-btn" onclick="adjustTime('setMin', -1, 59)">-</button>
                                <input id="setMin" class="time-display" value="30" readonly>
                                <button class="time-btn" onclick="adjustTime('setMin', 1, 59)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-lines">
                <div class="grid" id="cardsContainer"></div>
            </div>

            <div id="section-chart">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 style="margin:0; font-family:'JetBrains Mono'">PRODUCTION TREND</h3>
                        <div class="chart-filters">
                            <button class="active" onclick="setChartPeriod('daily', this)">LIVE</button>
                            <button onclick="setChartPeriod('weekly', this)">WEEKLY</button>
                            <button onclick="setChartPeriod('monthly', this)">MONTHLY</button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="productionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="container" id="viewHistory" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-family:'JetBrains Mono'; font-size:1.5rem; margin:0;">HISTORY LOGS</h2>
                <button onclick="downloadRealExcel()" style="background:#10b981; color:white; border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer; font-family:'Inter',sans-serif; display:flex; align-items:center; gap:8px;">
                    <svg style="width:16px;height:16px;fill:currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    DOWNLOAD .XLSX
                </button>
            </div>

            <div class="table-responsive">
                <table style="width:100%; border-collapse:collapse; color:#cbd5e1;">
                    <thead>
                        <tr style="border-bottom:1px solid #334155;">
                            <th style="padding:15px; text-align:left;">TIMESTAMP</th>
                            <th style="padding:15px; text-align:center;">TOTAL</th>
                            <th style="padding:15px; text-align:left;">DETAILS</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchMobileTab('lines', this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span>DASHBOARD</span>
        </div>
        <div class="nav-item" onclick="switchMobileTab('totals', this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M18 4H6v2l6.5 6L6 18v2h12v-3h-7l5-5-5-5h7z"/></svg>
            <span>TOTALS</span>
        </div>
        <div class="nav-item" onclick="switchMobileTab('chart', this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
            <span>GRAFIK</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        // CONFIG: MQTT (Broker EMQX Public)
        const mqttConfig = {
            host: "broker.emqx.io",
            port: 8084, // WSS Port for EMQX
            useSSL: true,
            path: "/mqtt",
            username: "",
            password: "",
            topicBase: "iot/produksi_baru" 
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAcA7CYQqoig7eVaMbopIQpq9EWn1mVudA",
            authDomain: "iot-phi.firebaseapp.com",
            databaseURL: "https://iot-phi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "iot-phi",
            appId: "1:367236392063:web:7586522c0989d343467657"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let latestCounter = {};
        let globalStartTime = null; 
        const targetCPM = 70; 
        const rates = Array(16).fill(targetCPM); 
        let prodChart = null;
        let currentChartMode = 'daily'; 

        // --- NAVIGATION HELPERS ---
        window.switchMobileTab = (tabName, btnElement) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            
            document.getElementById('section-lines').style.display = 'none';
            document.getElementById('section-totals').style.display = 'none';
            document.getElementById('section-chart').style.display = 'none';
            document.getElementById('viewHistory').style.display = 'none'; 
            document.getElementById('viewDashboard').style.display = 'block';

            if(tabName === 'lines') document.getElementById('section-lines').style.display = 'block';
            if(tabName === 'totals') document.getElementById('section-totals').style.display = 'block';
            if(tabName === 'chart') document.getElementById('section-chart').style.display = 'block';
        }

        window.toggleMobileDropdown = () => { document.getElementById('mobileDropdown').classList.toggle('active'); }
        window.syncSelect = (val) => {
            document.getElementById('machineSelectDesktop').value = val;
            document.getElementById('machineSelectMobile').value = val;
        }

        // --- LOGIN LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const userField = document.getElementById("username");
            const passField = document.getElementById("password");
            if(userField) userField.focus();
            if(userField) userField.addEventListener("keydown", function(event) { if(event.key === "Enter") { event.preventDefault(); passField.focus(); } });
            if(passField) passField.addEventListener("keydown", function(event) { if(event.key === "Enter") { event.preventDefault(); doLogin(); } });
        });

        window.adjustTime = (id, step, max) => {
            const el = document.getElementById(id);
            let val = parseInt(el.value);
            val += step;
            if (val > max) val = 0;
            if (val < 0) val = max;
            el.value = val.toString().padStart(2, '0');
        };

        window.doLogin = () => {
            const u = document.getElementById("username").value;
            const p = document.getElementById("password").value;
            if(u === "admin" && p === "admin123") {
                sessionStorage.setItem("login", "1");
                location.reload();
            } else {
                document.getElementById("error").innerText = "Invalid Credentials";
            }
        };
        window.logout = () => { sessionStorage.clear(); location.reload(); };

        window.onload = () => {
            if(document.getElementById("loginPage") && document.getElementById("loginPage").style.display !== "none") {
                if(document.getElementById("username")) document.getElementById("username").focus();
            }
            if(sessionStorage.getItem("login") === "1") {
                document.getElementById("loginPage").style.display = "none";
                document.getElementById("dashboardPage").style.display = "block";
                generateCards();
                initChart(); 
                syncGlobalStartTime();
                loadCache();
                connectMQTT();
                setInterval(updateClock, 1000);
                setInterval(updateUI, 1000);
            }
        };

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', {hour12: false});
            if(document.getElementById("clock")) document.getElementById("clock").innerText = timeStr;
            if(document.getElementById("mobileClock")) document.getElementById("mobileClock").innerText = timeStr; 
            
            const setH = parseInt(document.getElementById("setHour").value);
            const setM = parseInt(document.getElementById("setMin").value);
            if (now.getHours() === setH && now.getMinutes() === setM && now.getSeconds() === 0) {
                saveAndReset("ALL"); 
            }
        }

        function syncGlobalStartTime() {
            const startRef = ref(database, 'config/productionStartTime');
            onValue(startRef, (snap) => {
                if(snap.val()) globalStartTime = snap.val();
                else {
                    const now = Date.now();
                    set(startRef, now);
                    globalStartTime = now;
                }
            });
        }

       function updateUI() {
        if(!globalStartTime) return;
        const mins = Math.max(0, Date.now() - globalStartTime) / 60000;
        let gTot=0, cAct=0, cTeorythical=0, pAct=0, rTeorythical=0;

        // Loop sampai 15
        for(let i=1; i<=15; i++) {
            if(i === 13) continue;

            const act = latestCounter[`L${i}`] || 0;
            const teorythical = Math.floor(rates[i-1] * mins);
            const eff = teorythical>0 ? ((act/teorythical)*100).toFixed(1)+'%' : '0%';
            const isP = (i===5||i===6);
            
            if(isP) { pAct+=act; rTeorythical+=teorythical; } else { cAct+=act; cTeorythical+=teorythical; }
            
            const el = document.getElementById(`L${i}`);
            if(el) {
                // --- PERUBAHAN DISINI (ANIMASI) ---
                // 1. Ambil nilai lama yang sedang tampil di layar (hapus koma/titik ribuan)
                const currentDisplayed = parseInt(el.innerText.replace(/[^0-9]/g, '')) || 0;
                
                // 2. Jika nilai baru beda dengan nilai lama, jalankan animasi
                if (currentDisplayed !== act) {
                    // Durasi 1000ms (1 detik) agar gerakan terlihat smooth sesuai ritme kirim data ESP32
                    animateValue(el, currentDisplayed, act, 500);
                }
                // ----------------------------------

                document.getElementById(`P${i}`).innerText = teorythical.toLocaleString(); 
                const eEl = document.getElementById(`E${i}`); 
                eEl.innerText = eff;
                eEl.style.color = parseFloat(eff)>=90 ? getVar('--success') : parseFloat(eff)>=70 ? getVar('--warning') : getVar('--danger');
            }
            gTot+=act;
        }

        const final = gTot + manualOffset;
        
        // --- ANIMASIKAN JUGA TOTAL PRODUCTION ---
        const elTotal = document.getElementById("total");
        const currTotal = parseInt(elTotal.innerText.replace(/[^0-9]/g, '')) || 0;
        if(currTotal !== final) animateValue(elTotal, currTotal, final, 1000);
        // ----------------------------------------

        document.getElementById("clock").innerText = new Date().toLocaleString('id-ID');
        
        // Update Summary (Bisa dianimasikan juga jika mau, contoh di bawah pakai text biasa agar ringan)
        updSum("totalClub", cAct, cTeorythical); 
        updSum("totalRound", pAct, rTeorythical); 
        updSum("grandTotal", final, cTeorythical+rTeorythical);
    }
        function connectMQTT() {
            const client = mqtt.connect(`wss://${mqttConfig.host}:${mqttConfig.port}${mqttConfig.path}`, {
                username: mqttConfig.username,
                password: mqttConfig.password,
                clientId: 'web_dashboard_' + Math.random().toString(16).substr(2, 8)
            });

            client.on("connect", () => { 
                window.mqttClient = client; 
                for(let i=1; i<=7; i++) client.subscribe(`${mqttConfig.topicBase}/machine0${i}/counter`);
            });

            client.on("message", (topic, msg) => {
                try {
                    const data = JSON.parse(msg.toString());
                    const machine = topic.split('/')[2];
                    if(Object.values(data.counter).every(v => v === 0) && data.reset_source !== "web") return;
                    Object.assign(latestCounter, data.counter);
                    set(ref(database, `lastCache/${machine}`), data);
                } catch(e){}
            });
        }

        function generateCards() {
            const c = document.getElementById("cardsContainer");
            c.innerHTML = "";
            for(let i=1; i<=15; i++) {
                if(i === 13) continue; 

                let badgeClass = (i === 5 || i === 6) ? "badge-pouch" : "badge-club";
                let typeName = (i === 5 || i === 6) ? "ROUNDCAN" : "CLUBCAN";
                
                c.innerHTML += `
                <div class="card">
                    <div class="card-header">
                        <div><span class="card-title">LINE ${i.toString().padStart(2,'0')}</span><span class="badge ${badgeClass}">${typeName}</span></div>
                        <span class="card-speed">70 CPM</span>
                    </div>
                    <table class="mini-table">
                        <colgroup><col style="width:40%"><col style="width:30%"><col style="width:30%"></colgroup>
                        <tr><th>Actual</th><th style="text-align:center">THEORITICAL</th><th style="text-align:right">Eff %</th></tr>
                        <tr><td class="data-val" id="L${i}">0</td><td class="data-val" style="text-align:center" id="P${i}">0</td><td class="data-val" style="text-align:right" id="E${i}">0%</td></tr>
                    </table>
                </div>`;
            }
        }

        async function saveAndReset(targetMachine) {
            const totalC = document.getElementById("clubActual").innerText;
            const totalP = document.getElementById("pouchActual").innerText;
            const grand = document.getElementById("grandTotal").innerText;

            await push(ref(database, 'history'), {
                time: new Date().toLocaleString('id-ID'), 
                grandTotal: grand,
                detail: { club: totalC, pouch: totalP },
                counter: {...latestCounter}, 
                resetType: targetMachine
            });
            await set(ref(database, 'config/productionStartTime'), Date.now());
            if(prodChart) { prodChart.data.labels=[]; prodChart.data.datasets[0].data=[]; prodChart.update(); }

            if(window.mqttClient && window.mqttClient.connected) {
                if(targetMachine === "ALL") {
                    for(let i=1; i<=7; i++) {
                        window.mqttClient.publish(`${mqttConfig.topicBase}/machine0${i}/cmd`, JSON.stringify({ cmd: "RESET", reset_source: "web" }));
                    }
                } else {
                    window.mqttClient.publish(`${mqttConfig.topicBase}/${targetMachine}/cmd`, JSON.stringify({ cmd: "RESET", reset_source: "web" }));
                }
            } else {
                alert("MQTT Disconnected. Reset command sent locally only.");
            }

            for (let i = 1; i <= 15; i++) { latestCounter[`L${i}`] = 0; }
            updateUI(); 
        }

        window.manualSave = async (isAuto = false) => {
            if(isAuto || confirm("Simpan Data ke History?")) {
                const totalC = document.getElementById("clubActual").innerText;
                const totalP = document.getElementById("pouchActual").innerText;
                const grand = document.getElementById("grandTotal").innerText;
                await push(ref(database, 'history'), {
                    time: new Date().toLocaleString('id-ID'),
                    grandTotal: grand,
                    detail: { club: totalC, pouch: totalP },
                    counter: {...latestCounter},
                    type: "Manual Save"
                });
                if(!isAuto) alert("Data berhasil disimpan ke History!");
            }
        };

        window.resetCounter = async () => {
            let m = document.getElementById("machineSelectDesktop").value;
            if(window.innerWidth <= 768) { m = document.getElementById("machineSelectMobile").value; }
            if(!m) return alert("Pilih Mesin atau Reset All dulu!");
            
            let confirmMsg = (m === 'all') ? "RESET SEMUA MESIN? Data akan disimpan otomatis." : `RESET ${m.toUpperCase()}? Data akan disimpan otomatis.`;
            if(confirm(confirmMsg)) {
                let target = (m === 'all') ? "ALL" : m;
                await saveAndReset(target);
                alert("Perintah Reset dikirim & Data disimpan.");
            }
        };

        async function loadCache() {
            const snap = await get(ref(database, 'lastCache'));
            if(snap.exists()) {
                const d = snap.val();
                Object.keys(d).forEach(k => { if(d[k].counter) Object.assign(latestCounter, d[k].counter); });
            }
        }

        window.initChart = () => {
            const ctx = document.getElementById('productionChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0,0,0,300);
            gradient.addColorStop(0, 'rgba(56, 189, 248, 0.5)'); 
            gradient.addColorStop(1, 'rgba(56, 189, 248, 0)');

            prodChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Grand Total', data: [], borderColor: '#38bdf8', backgroundColor: gradient, fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: {display:false} },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { family: "'JetBrains Mono', monospace" }, callback: function(val) { return val >= 1000 ? (val/1000) + 'k' : val; } } },
                        x: { grid: {display:false}, ticks: { color: '#94a3b8', font: { family: "'JetBrains Mono', monospace" }, maxTicksLimit: 6, maxRotation: 0, autoSkip: true } }
                    }
                }
            });
        };

        function updateRealtimeChart(val) {
            if (currentChartMode !== 'daily') return;
            const now = new Date();
            const time = now.getHours() + ":" + (now.getMinutes()<10?'0':'')+now.getMinutes();
            if(prodChart.data.labels.length === 0 || prodChart.data.labels[prodChart.data.labels.length-1] !== time) {
                prodChart.data.labels.push(time);
                prodChart.data.datasets[0].data.push(val);
                if(prodChart.data.labels.length > 720) { prodChart.data.labels.shift(); prodChart.data.datasets[0].data.shift(); }
                prodChart.update();
            } else {
                prodChart.data.datasets[0].data[prodChart.data.datasets[0].data.length-1] = val;
                prodChart.update('none');
            }
        }

        window.setChartPeriod = (period, btn) => {
            document.querySelectorAll('.chart-filters button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentChartMode = period;
            prodChart.data.labels = [];
            prodChart.data.datasets[0].data = [];
            if(period === 'daily') {} 
            else if(period === 'weekly') { prodChart.data.labels = ['MON','TUE','WED','THU','FRI','SAT','SUN']; prodChart.data.datasets[0].data = [15000, 18000, 16000, 20000, 22000, 15000, 5000]; } 
            else if (period === 'monthly') { prodChart.data.labels = ['WEEK 1','WEEK 2','WEEK 3','WEEK 4']; prodChart.data.datasets[0].data = [100000, 120000, 110000, 130000]; }
            prodChart.update();
        }

        window.switchView = (v) => {
            if(v === 'history') {
                loadHistoryTable();
                document.getElementById('viewDashboard').style.display = 'none';
                document.getElementById('viewHistory').style.display = 'block';
                if(window.innerWidth <= 768) {
                    document.getElementById('section-lines').style.display = 'none';
                    document.getElementById('section-totals').style.display = 'none';
                    document.getElementById('section-chart').style.display = 'none';
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                }
            } else {
                document.getElementById('viewHistory').style.display = 'none';
                document.getElementById('viewDashboard').style.display = 'block';
                if(window.innerWidth <= 768) {
                   switchMobileTab('lines', document.querySelector('.nav-item'));
                }
            }
        };

        async function loadHistoryTable() {
            const b = document.getElementById("historyTableBody");
            b.innerHTML = "<tr><td colspan='3'>Loading data...</td></tr>";
            const snap = await get(ref(database, 'history'));
            b.innerHTML = "";
            if(snap.exists()) {
                Object.values(snap.val()).reverse().forEach(h => {
                    let clubInfo = h.detail ? `<span style='color:var(--primary)'>Club: ${h.detail.club}</span> | <span style='color:var(--purple)'>Round: ${h.detail.pouch}</span>` : '-';
                    let totalShow = h.grandTotal ? h.grandTotal : h.total;
                    b.innerHTML += `<tr>
                        <td style="padding:15px; font-family:'JetBrains Mono'; border-bottom:1px solid #334155;">${h.time}</td>
                        <td style="padding:15px; color:var(--success); font-weight:bold; font-family:'JetBrains Mono'; border-bottom:1px solid #334155; text-align:center;">${totalShow}</td>
                        <td style="padding:15px; font-size:0.85rem; border-bottom:1px solid #334155;">${clubInfo}</td>
                    </tr>`;
                });
            } else {
                b.innerHTML = "<tr><td colspan='3' style='text-align:center; padding:20px;'>Belum ada data history</td></tr>";
            }
        }

        // ==========================================
        //  FUNGSI DOWNLOAD EXCEL ASLI (.XLSX)
        //  MENGGUNAKAN LIBRARY SHEETJS (XLSX.JS)
        // ==========================================
        window.downloadRealExcel = async () => {
            const snap = await get(ref(database, 'history'));
            if (!snap.exists()) return alert("Tidak ada data history untuk didownload!");

            // 1. SIAPKAN DATA
            const dataRaw = Object.values(snap.val());
            const dataSheet = [];

            // Header Kolom
            dataSheet.push(["WAKTU & TANGGAL", "TOTAL CLUBCAN", "TOTAL ROUNDCAN", "GRAND TOTAL"]);

            // Helper untuk membersihkan angka (hapus koma/titik ribuan lalu jadi number)
            const parseNum = (str) => {
                if(!str) return 0;
                // Hapus semua karakter yang bukan angka
                const clean = str.toString().replace(/\D/g, ''); 
                return parseInt(clean) || 0;
            };

            // Masukkan data baris per baris
            dataRaw.forEach(row => {
                dataSheet.push([
                    row.time || "-", 
                    parseNum(row.detail?.club), 
                    parseNum(row.detail?.pouch), 
                    parseNum(row.grandTotal || row.total)
                ]);
            });

            // 2. BUAT WORKBOOK & WORKSHEET
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataSheet);

            // 3. ATUR LEBAR KOLOM (Supaya tidak sempit/####)
            ws['!cols'] = [
                { wch: 25 }, // Kolom Waktu
                { wch: 20 }, // Kolom Clubcan
                { wch: 20 }, // Kolom Roundcan
                { wch: 20 }  // Kolom Grand Total
            ];

            // 4. FREEZE PANES (KUNCI BARIS PERTAMA)
            // state: frozen, xSplit: 0, ySplit: 1 (Baris 1 diam)
            ws['!views'] = [
                { state: 'frozen', xSplit: 0, ySplit: 1 }
            ];

            // 5. SIMPAN FILE SEBAGAI .XLSX ASLI
            XLSX.utils.book_append_sheet(wb, ws, "Produksi");
            const dateStr = new Date().toISOString().slice(0,10);
            XLSX.writeFile(wb, `Produksi_PHI_${dateStr}.xlsx`);
        };
    </script>
</body>
</html>